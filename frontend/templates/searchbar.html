<div class="search-bar-container">
  <form id="searchForm">
    <!-- AND -->
    <div class="search-bar-wrapper tags-input" data-type="and">
      <div class="tags"></div>
      <input type="text" id="andInput" placeholder="Keyword AND..." />
    </div>

    <!-- OR -->
    <div class="search-bar-wrapper tags-input" data-type="or">
      <div class="tags"></div>
      <input type="text" id="orInput" placeholder="Keyword OR..." />
    </div>

    <!-- NOT -->
    <div class="search-bar-wrapper tags-input" data-type="not">
      <div class="tags"></div>
      <input type="text" id="notInput" placeholder="Keyword NOT..." />
    </div>

    <button type="submit" class="modern-button">Search</button>
  </form>
</div>

<script>
  document.querySelectorAll('.tags-input').forEach(wrapper => {
    const input = wrapper.querySelector('input');
    const tagContainer = wrapper.querySelector('.tags');
    const keywords = [];

    input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && input.value.trim()) {
        e.preventDefault();
        const value = input.value.trim();

        if (!keywords.includes(value)) {
          keywords.push(value);

          const tag = document.createElement('span');
          tag.className = 'tag';
          tag.textContent = value;

          const removeBtn = document.createElement('span');
          removeBtn.className = 'remove-tag';
          removeBtn.textContent = 'Ã—';
          removeBtn.onclick = () => {
            tagContainer.removeChild(tag);
            keywords.splice(keywords.indexOf(value), 1);
          };

          tag.appendChild(removeBtn);
          tagContainer.appendChild(tag);
          input.value = '';
        }
      }
    });

    wrapper.getKeywords = () => [...keywords];
  });

  document.getElementById('searchForm').addEventListener('submit', async function (e) {
  e.preventDefault();
  const wrappers = document.querySelectorAll('.tags-input');

  const query = {
    and: wrappers[0].getKeywords(),
    or: wrappers[1].getKeywords(),
    not: wrappers[2].getKeywords()
  };

  // ðŸš« Prevent API call if both AND and OR are empty
  const hasValidInput = query.and.length || query.or.length;
  if (!hasValidInput) {
    console.warn('Search aborted: no AND or OR keywords provided.');
    return;
  }

  // âœ… Proceed to build URL
  const url = new URL('/api/search', window.location.origin);
  query.and.forEach(k => url.searchParams.append('and', k));
  query.or.forEach(k => url.searchParams.append('or', k));

  // Only add NOT if AND or OR are present
  query.not.forEach(k => url.searchParams.append('not', k));

  try {
    const res = await fetch(url);
    const data = await res.json();

    if (res.ok) {
      window.SearchStore.setQuery(query);
      window.SearchStore.setResults(data.articles || []);
    } else {
      console.error('Search failed:', data.error || data);
    }
  } catch (err) {
    console.error('Fetch error:', err);
  }
});


</script>
